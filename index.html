<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIMU | Production Management</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    
    <style>
        :root { 
            --brand-taupe: #95866f; --brand-dark: #373a3c; --off-white: #f8f9fa;
            --lv-urgent: #fee2e2; --lv-tight: #fef3c7; --lv-normal: #f3f4f6; --lv-relax: #eff6ff;
        }
        body { font-family: "Helvetica Neue", sans-serif; background: var(--off-white); margin: 0; padding: 20px; color: var(--brand-dark); }
        .nav { text-align: center; margin-bottom: 30px; }
        .nav button { background: none; border: none; padding: 10px 20px; cursor: pointer; color: #999; letter-spacing: 2px; transition: 0.3s; }
        .nav button.active-btn { color: var(--brand-dark); border-bottom: 2px solid var(--brand-dark); font-weight: bold; }
        .page-container { display: none; background: white; max-width: 900px; margin: 0 auto; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .active { display: block; }

        /* STATISTICS 漂亮排版 */
        .stats-summary-card { text-align: center; padding: 30px; border-bottom: 1px solid #eee; margin-bottom: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
        .stats-card { 
            background: #fff; border: 1px solid #eaeaea; padding: 20px; border-radius: 10px; 
            transition: transform 0.2s; position: relative; overflow: hidden;
        }
        .stats-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .stats-card::before { content: ""; position: absolute; left: 0; top: 0; height: 100%; width: 4px; background: var(--brand-taupe); }
        .stats-card-title { font-size: 0.8rem; font-weight: bold; color: var(--brand-dark); margin-bottom: 8px; line-height: 1.4; display: block; }
        .stats-card-info { font-size: 0.75rem; color: #888; letter-spacing: 0.5px; }
        .stats-card-num { position: absolute; bottom: 15px; right: 20px; font-size: 1.5rem; font-weight: 200; color: var(--brand-taupe); }

        /* Status 顏色 */
        .order-card { padding: 20px 0; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .countdown-label { font-size: 0.65rem; padding: 3px 10px; border-radius: 12px; font-weight: bold; margin-bottom: 5px; display: inline-block; }
        
        .btn-submit { background: var(--brand-dark); color: white; border: none; padding: 15px; width: 100%; border-radius: 6px; cursor: pointer; letter-spacing: 2px; margin-top: 20px; }
    </style>
</head>
<body>

<div class="nav">
    <button id="btnForm" class="active-btn" onclick="showTab('form')">NEW ORDER</button>
    <button id="btnAdmin" onclick="showTab('admin')">STATUS</button>
    <button id="btnStats" onclick="showTab('stats')">STATISTICS</button>
</div>

<div id="formTab" class="page-container active">
    <div style="text-align:center; margin-bottom:30px;"><h2>NEW ORDER</h2></div>
    <div class="form-group"><label>Order ID</label><input type="text" id="orderId" placeholder="SL-0000" style="width:100%; padding:10px; margin-bottom:20px;"></div>
    <div class="form-group"><label>Order Date</label><input type="date" id="orderDate" onchange="updateExpectedDate(this.value)" style="width:100%; padding:10px; margin-bottom:10px;"></div>
    <div id="expectedHint" style="font-size:0.8rem; color:var(--brand-taupe); font-weight:bold; margin-bottom:20px;"></div>
    
    <div style="background:#f9f9f9; padding:20px; border-radius:8px;">
        <label>ITEM 01</label>
        <select id="style1"></select><br>
        <select id="color1"></select><br>
        <select id="size1"></select>
    </div>
    <button id="submitBtn" class="btn-submit" onclick="submitOrder()">CREATE ORDER</button>
</div>

<div id="adminTab" class="page-container">
    <div id="orderList">載入中...</div>
</div>

<div id="statsTab" class="page-container">
    <div class="stats-summary-card">
        <span style="font-size:0.7rem; letter-spacing:2px; color:#999;">TOTAL ACTIVE PIECES</span>
        <div id="totalPieces" style="font-size:3rem; font-weight:200;">0</div>
    </div>
    <div style="display:flex; gap:10px; margin-bottom:30px;">
        <select id="filterCat"></select>
        <select id="filterStyle"></select>
    </div>
    <div id="statsGrid" class="stats-grid"></div>
</div>

<script>
    const scriptUrl = "YOUR_GAS_URL"; // 這裡填入妳的 GAS 連結
    let allOrders = null;
    let masterData = [];
    let choiceInstances = {};

    async function showTab(t) {
        document.querySelectorAll('.page-container').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav button').forEach(e => e.classList.remove('active-btn'));
        document.getElementById(t + 'Tab').classList.add('active');
        document.getElementById('btn' + t.charAt(0).toUpperCase() + t.slice(1)).classList.add('active-btn');
        
        // 只有在資料為空時才 fetch，減少等待時間
        if (!allOrders) {
            const res = await fetch(`${scriptUrl}?action=getOrders`);
            allOrders = (await res.json()).slice(1);
        }
        
        if (t === 'admin') renderOrders();
        if (t === 'stats') renderStatistics();
    }

    async function submitOrder() {
        const btn = document.getElementById('submitBtn');
        btn.innerText = "SENDING..."; btn.disabled = true;

        const oDate = document.getElementById('orderDate').value;
        const d = new Date(oDate);
        d.setDate(d.getDate() + 42); // 六週
        const deadline = d.toISOString().split('T')[0];

        const payload = {
            action: 'addOrder',
            data: {
                id: document.getElementById('orderId').value,
                orderDate: oDate,  // 對應 B 欄
                deadline: deadline, // 對應 C 欄
                s1: document.getElementById('style1').value,
                c1: document.getElementById('color1').value,
                z1: document.getElementById('size1').value,
                s2: "", c2: "", z2: "" // 範例僅單筆，可自行擴充
            }
        };

        await fetch(scriptUrl, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
        alert("訂單已建立！預計交期：" + deadline);
        location.reload();
    }

    function renderStatistics() {
        const fCat = document.getElementById('filterCat').value;
        const fStyle = document.getElementById('filterStyle').value;
        let map = {}; let total = 0;

        allOrders.forEach(r => {
            const status = (r[9] || "").trim();
            if (status === "出貨完畢" || status === "已寄回") return;

            // 判讀 A/B/C
            const style = r[3];
            if (!style) return;
            const code = style.trim().charAt(0).toUpperCase();
            let cat = (code === 'A') ? "TOP" : (code === 'B') ? "BOTTOM" : "ONEPIECE";

            if ((fCat==="" || cat===fCat) && (fStyle==="" || style===fStyle)) {
                const key = `${style} | ${r[4]} | ${r[5]}`;
                map[key] = (map[key] || 0) + 1;
                total++;
            }
        });

        document.getElementById('totalPieces').innerText = total;
        let html = '';
        for (let k in map) {
            const parts = k.split(' | ');
            html += `
                <div class="stats-card">
                    <span class="stats-card-title">${parts[0]}</span>
                    <span class="stats-card-info">${parts[1]} / SIZE: ${parts[2]}</span>
                    <div class="stats-card-num">${map[k]}</div>
                </div>`;
        }
        document.getElementById('statsGrid').innerHTML = html || "No records found.";
    }

    function renderOrders() {
        const today = new Date().setHours(0,0,0,0);
        let html = '';
        allOrders.slice().reverse().forEach(r => {
            const deadline = new Date(r[2]);
            const diff = Math.ceil((deadline - today) / 86400000);
            let lv = (diff <= 7) ? 'var(--lv-urgent)' : (diff <= 14) ? 'var(--lv-tight)' : 'var(--lv-normal)';
            
            html += `
                <div class="order-card">
                    <div>
                        <div class="countdown-label" style="background:${lv}">${diff} DAYS LEFT</div><br>
                        <b>#${r[0]}</b> <span style="font-size:0.7rem; color:#999;">(EXP: ${r[2]})</span>
                        <div style="font-size:0.8rem; color:#666; margin-top:5px;">${r[3]} / ${r[4]} / ${r[5]}</div>
                    </div>
                    <div><span style="font-size:0.75rem; font-weight:bold;">${r[9] || "新訂單"}</span></div>
                </div>`;
        });
        document.getElementById('orderList').innerHTML = html;
    }

    function updateExpectedDate(v) {
        let d = new Date(v); d.setDate(d.getDate() + 42);
        document.getElementById('expectedHint').innerText = `⮕ Expected Delivery: ${d.toISOString().split('T')[0]} (6 weeks)`;
    }

    window.onload = async () => {
        document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
        updateExpectedDate(document.getElementById('orderDate').value);
        // 初始化 Select 元件... (其餘 init 代碼)
    }
</script>
</body>
</html>
