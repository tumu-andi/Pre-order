// 顏色自動抓取核心邏輯 - 高容錯加強版
    function updateColorOptions(styleId, colorId) {
        const selectedStyle = document.getElementById(styleId).value.trim().toLowerCase();
        const colorChoice = choiceInstances[colorId];
        
        // 取得所有唯一的顏色清單，並做預處理
        const allAvailableColors = [...new Set(masterData.map(i => i[1]))].filter(String);

        // 強力重置選單狀態
        colorChoice.clearStore(); 

        if (!selectedStyle) {
            const allOpts = allAvailableColors.sort().map(c => ({ value: c, label: c, selected: false }));
            colorChoice.setChoices([{ value: '', label: 'COLOR...', selected: true, disabled: false }].concat(allOpts), 'value', 'label', true);
            return;
        }

        // 模糊篩選：不分大小寫比對
        let matchedColors = allAvailableColors.filter(colorName => {
            const pureColor = colorName.trim().toLowerCase();
            return selectedStyle.includes(pureColor);
        });

        // 排序：字數長的優先（防止「黑色」蓋掉「黑色泡泡布」）
        matchedColors.sort((a, b) => b.length - a.length);

        // 如果完全沒對應到，則顯示全部顏色供手動選
        let noMatch = false;
        if (matchedColors.length === 0) {
            matchedColors = allAvailableColors.sort();
            noMatch = true;
        }
        
        // 準備選項物件
        const finalChoices = matchedColors.map(c => {
            const isAutoMatch = (!noMatch && matchedColors.length === 1); 
            return {
                value: c,
                label: c,
                selected: isAutoMatch // 如果只有一個匹配項，強制設為選取
            };
        });

        // 裝填選項
        colorChoice.setChoices([
            { value: '', label: 'COLOR...', selected: (noMatch || matchedColors.length !== 1), disabled: false }
        ].concat(finalChoices), 'value', 'label', true);

        // 【關鍵修正】強制讓 Choices.js 的顯示與內部數值同步
        if (!noMatch && matchedColors.length === 1) {
            colorChoice.setChoiceByValue(matchedColors[0]);
        }
    }
