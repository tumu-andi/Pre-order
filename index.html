<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIMU | 生產管理系統</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    
    <style>
        :root { 
            --timu-beige: #f9f8f6; --timu-dark: #333333; --timu-gold: #c5a35d; 
            --timu-light-gold: #e5d5b5; --text-light: #777;
        }

        body { font-family: "Helvetica Neue", "PingFang TC", sans-serif; background: var(--timu-beige); color: var(--timu-dark); padding: 20px; margin: 0; }

        /* 導覽列 */
        .nav { text-align: center; margin: 10px 0 40px 0; position: sticky; top: 0; z-index: 1000; background: var(--timu-beige); padding: 15px 0; }
        .nav button { background: transparent; border: none; color: var(--text-light); padding: 12px 25px; cursor: pointer; margin: 0 5px; letter-spacing: 2px; font-size: 0.95rem; }
        .nav button.active-btn { color: var(--timu-dark); border-bottom: 2px solid var(--timu-gold); font-weight: bold; }

        .page-container { display: none; background: white; margin: 0 auto 50px auto; padding: 45px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.04); }
        #formTab { max-width: 550px; }
        #adminTab, #calendarTab, #statsTab { max-width: 950px; }
        .active { display: block; }
        .title-group { text-align: center; margin-bottom: 45px; }
        h2 { font-weight: 400; letter-spacing: 8px; margin: 0; color: var(--timu-gold); font-size: 1.6rem; }
        .sub-title { font-size: 0.9rem; color: #aaa; margin-top: 8px; }

        /* NEW ORDER: 底線設計 */
        .choices__inner { background-color: transparent !important; border: none !important; border-bottom: 1.5px solid #eee !important; padding: 10px 0 !important; border-radius: 0 !important; min-height: auto !important; }
        .choices__list--single { padding: 0 !important; }
        .choices[data-type*="select-one"]::after { border-color: var(--timu-gold) transparent transparent transparent !important; }
        
        label { display: block; font-size: 0.8rem; margin-top: 25px; color: var(--timu-dark); font-weight: 600; }
        input { padding: 14px 0; margin: 5px 0; border: none; border-bottom: 1.5px solid #eee !important; font-size: 1.05rem; width: 100%; background: transparent !important; }
        .section-header { font-size: 1rem; font-weight: bold; margin: 45px 0 10px 0; color: var(--timu-dark); letter-spacing: 2px; border-left: 4px solid var(--timu-gold); padding-left: 12px; }
        .btn-submit { background: var(--timu-dark); color: white; border: none; padding: 20px; width: 100%; margin-top: 45px; cursor: pointer; letter-spacing: 5px; font-size: 1rem; border-radius: 6px; font-weight: bold; }

        /* STATUS: 簡約排版 */
        .order-item { border-bottom: 1px solid #f2f2f2; padding: 35px 0; }
        .date-display { display: flex; align-items: center; gap: 15px; font-size: 0.85rem; color: #888; margin: 10px 0; }
        .date-chip { color: var(--timu-dark); font-weight: 500; }
        .deadline-highlight { color: var(--timu-gold); font-weight: 700; border-bottom: 1px solid var(--timu-light-gold); }
        .item-detail { font-size: 0.95rem; color: #555; margin-top: 20px; line-height: 2.2; border-left: 2px solid var(--timu-gold); padding-left: 20px; }
        .item-detail b { color: var(--timu-gold); margin-right: 5px; font-size: 1.1rem; }
        
        /* 狀態標籤顏色 */
        .status-tag { padding: 6px 18px; border-radius: 50px; font-size: 0.8rem; color: white; font-weight: bold; display: inline-block; }
        .status-新訂單 { background-color: #555 !important; }
        .status-備料中 { background-color: #aaa !important; }
        .status-車縫中 { background-color: #8da9c4 !important; }
        .status-已寄回 { background-color: #a69cac !important; }
        .status-出貨完畢 { background-color: #84a59d !important; }

        /* STATISTICS: 篩選列 */
        .stats-filter-bar { display: flex; gap: 15px; margin-bottom: 30px; background: #fcfcfc; padding: 15px; border-radius: 8px; }
        .filter-select-mini { flex: 1; border: none; border-bottom: 1px solid #ddd; padding: 8px; font-size: 0.85rem; background: transparent; }

        /* CALENDAR: 懸浮視窗 (Modal) */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(8px); }
        .modal-content { background: white; margin: 10% auto; padding: 40px; border-radius: 15px; width: 85%; max-width: 450px; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.15); animation: floatUp 0.3s ease-out; }
        @keyframes floatUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

<div class="nav">
    <button id="btnForm" class="active-btn" onclick="showTab('form')">NEW ORDER</button>
    <button id="btnAdmin" onclick="showTab('admin')">STATUS</button>
    <button id="btnCalendar" onclick="showTab('calendar')">CALENDAR</button>
    <button id="btnStats" onclick="showTab('stats')">STATISTICS</button>
</div>

<div id="formTab" class="page-container active">
    <div class="title-group"><h2>NEW ORDER</h2><div class="sub-title">建立新訂製單</div></div>
    <label>Order ID</label><input type="text" id="orderId" placeholder="SHOPLINE 編號">
    <label>Order Date</label>
    <div style="display:flex; align-items:center; gap:15px;">
        <input type="date" id="orderDate" onchange="calculateExpectedDate(this.value)">
        <div id="expectedHint" style="font-size:0.9rem; color:var(--timu-gold); font-weight:bold;"></div>
    </div>
    <div class="section-header">ITEM 1</div>
    <label>Style</label><select id="style1"></select>
    <label>Color</label><select id="color1"></select>
    <label>Size</label><select id="size1"></select>
    <div class="section-header">ITEM 2</div>
    <label>Style</label><select id="style2"></select>
    <label>Color</label><select id="color2"></select>
    <label>Size</label><select id="size2"></select>
    <button id="submitBtn" class="btn-submit" onclick="submitOrder()">CREATE ORDER</button>
</div>

<div id="adminTab" class="page-container">
    <div class="title-group"><h2>PRODUCTION STATUS</h2><div class="sub-title">生產進度管理</div></div>
    <div id="orderList">載入中...</div>
</div>

<div id="calendarTab" class="page-container">
    <div class="title-group"><h2>CALENDAR</h2><div class="sub-title">預計交期日曆</div></div>
    <div id="calendar"></div>
</div>

<div id="statsTab" class="page-container">
    <div class="title-group"><h2>STATISTICS</h2><div class="sub-title">款式生產彙整統計</div></div>
    <div class="stats-filter-bar">
        <select id="filterCat" class="filter-select-mini" onchange="renderStatistics()">
            <option value="">所有類別 (All Category)</option>
            <option value="TOP">TOP (上衣)</option>
            <option value="BOTTOM">BOTTOM (下身)</option>
            <option value="ONEPIECE">ONEPIECE (連身)</option>
        </select>
        <select id="filterStyle" class="filter-select-mini" onchange="renderStatistics()"><option value="">所有款式 (All Style)</option></select>
        <select id="filterColor" class="filter-select-mini" onchange="renderStatistics()"><option value="">所有顏色 (All Color)</option></select>
    </div>
    <table style="width:100%; border-collapse:collapse;">
        <thead style="background:var(--timu-beige);">
            <tr><th style="text-align:left; padding:15px; font-size:0.8rem;">款式詳情</th><th style="text-align:right; padding:15px; font-size:0.8rem;">待製作數量</th></tr>
        </thead>
        <tbody id="statsTableBody"></tbody>
    </table>
</div>

<div id="orderModal" class="modal">
    <div class="modal-content">
        <span style="position:absolute; right:25px; top:20px; cursor:pointer; font-size:24px; color:#ccc;" onclick="closeModal()">&times;</span>
        <div id="modalTitle" style="font-weight:bold; border-bottom:1px solid var(--timu-gold); padding-bottom:15px; margin-bottom:20px; font-size:1.3rem;"></div>
        <div id="modalBody" style="line-height:2;"></div>
    </div>
</div>

<script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbyi0WHv5eEFxL5XVKiPsr_iU6Ipoa0OxJJQvTjmjzicQTrNRK16fTUqD2_qeskcoXVcZg/exec"; // ⚠️ 請貼上妳的 GAS 部署網址
    let allOrders = [];
    let calendar;

    function showTab(t) {
        document.querySelectorAll('.page-container').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav button').forEach(e => e.classList.remove('active-btn'));
        document.getElementById(t + 'Tab').classList.add('active');
        document.getElementById('btn' + t.charAt(0).toUpperCase() + t.slice(1)).classList.add('active-btn');
        
        if (allOrders.length === 0) loadOrders();
        else {
            if (t === 'admin') renderOrders(allOrders.slice().reverse());
            if (t === 'calendar') setTimeout(renderCalendar, 100);
            if (t === 'stats') renderStatistics();
        }
    }

    function loadOrders() {
        const listDiv = document.getElementById('orderList');
        if (listDiv) listDiv.innerHTML = "載入中...";
        
        fetch(`${scriptUrl}?action=getOrders`)
            .then(res => res.json())
            .then(data => {
                allOrders = data.slice(1);
                const activeTab = document.querySelector('.page-container.active').id;
                renderOrders(allOrders.slice().reverse());
                if (activeTab === 'calendarTab') renderCalendar();
                if (activeTab === 'statsTab') renderStatistics();
            });
    }

    function renderOrders(orders) {
        const listDiv = document.getElementById('orderList');
        let html = '';
        orders.forEach(row => {
            const status = (row[9] || "新訂單").trim();
            const orderDate = row[1] ? row[1].split('T')[0].replace(/-/g, '/') : '-';
            const deadline = row[2] ? row[2].split('T')[0].replace(/-/g, '/') : '-';
            
            html += `<div class="order-item">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div style="flex:1;">
                        <div style="font-size:1.2rem; font-weight:bold;">#${row[0]}</div>
                        <div class="date-display">
                            <span>ORDER <span class="date-chip">${orderDate}</span></span>
                            <span style="color:#eee;">|</span>
                            <span>DEADLINE <span class="deadline-highlight">${deadline}</span></span>
                        </div>
                        <div class="item-detail">
                            <b>①</b> ${row[3]} / ${row[4]} / ${row[5]}
                            ${row[6] ? '<br><b>②</b> '+row[6]+' / '+row[7]+' / '+row[8] : ''}
                        </div>
                        <div style="margin-top:20px; display:flex; gap:10px;">
                            <input type="text" id="note-${row[0]}" value="${row[11]||''}" placeholder="備註 Note..." style="font-size:0.9rem; border-bottom:1px solid #f0f0f0 !important; flex:1;">
                            <button onclick="updateNote('${row[0]}')" style="background:var(--timu-gold); border:none; color:white; border-radius:4px; padding:0 15px; cursor:pointer; font-weight:bold;">SAVE</button>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <span class="status-tag status-${status}">${status}</span>
                        <div style="margin-top:15px;">
                            <select onchange="updateStatus('${row[0]}', this.value)" style="width:130px; border:1px solid #eee !important; font-size:0.8rem; padding:5px; border-radius:4px;">
                                <option value="">變更狀態</option>
                                <option value="新訂單">新訂單</option><option value="備料中">備料中</option>
                                <option value="車縫中">車縫中</option><option value="已寄回">已寄回</option>
                                <option value="出貨完畢">出貨完畢</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>`;
        });
        listDiv.innerHTML = html || "暫無訂單資料";
    }

    function renderStatistics() {
        const tbody = document.getElementById('statsTableBody');
        const fCat = document.getElementById('filterCat').value;
        const fStyle = document.getElementById('filterStyle').value;
        const fColor = document.getElementById('filterColor').value;
        const statsMap = {};

        allOrders.filter(row => !["已寄回", "出貨完畢"].includes((row[9]||"").trim())).forEach(row => {
            const items = [[row[3], row[4], row[5]], [row[6], row[7], row[8]]];
            items.forEach(it => {
                if(!it[0]) return;
                const name = it[0].toUpperCase();
                let cat = "OTHER";
                if(name.includes("TOP") || name.includes("BRA")) cat = "TOP";
                else if(name.includes("BOTTOM") || name.includes("LEGGING") || name.includes("BIKINI")) cat = "BOTTOM";
                else if(name.includes("ONEPIECE") || name.includes("SUIT")) cat = "ONEPIECE";

                if((fCat==="" || cat===fCat) && (fStyle==="" || it[0]===fStyle) && (fColor==="" || it[1]===fColor)) {
                    const key = `${it[0]} / ${it[1]} / ${it[2]}`;
                    statsMap[key] = (statsMap[key] || 0) + 1;
                }
            });
        });

        let html = '';
        Object.keys(statsMap).sort().forEach(key => {
            html += `<tr><td style="padding:20px 15px; border-bottom:1px solid #eee;">${key}</td><td style="text-align:right; padding:20px 15px; border-bottom:1px solid #eee;"><span style="font-weight:800; font-size:1.3rem;">${statsMap[key]}</span> <small>PCS</small></td></tr>`;
        });
        tbody.innerHTML = html || '<tr><td colspan="2" style="text-align:center; padding:50px; color:#ccc;">無匹配項目</td></tr>';
    }

    function renderCalendar() {
        const calendarEl = document.getElementById('calendar');
        const events = allOrders.map(row => {
            const status = (row[9] || "新訂單").trim();
            const deadline = row[2] ? row[2].split('T')[0] : '';
            if(!deadline) return null;
            let color = '#555'; if(status === '備料中') color = '#aaa'; if(status === '車縫中') color = '#8da9c4'; if(status === '已寄回') color = '#a69cac'; if(status === '出貨完畢') color = '#84a59d';
            return { title: `${row[0]} | ${row[3]}`, start: deadline, backgroundColor: color, borderColor: color, extendedProps: {row} };
        }).filter(e => e);

        if (calendar) calendar.destroy();
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth', locale: 'zh-tw', events: events, height: 'auto',
            eventClick: function(info) {
                const r = info.event.extendedProps.row;
                document.getElementById('modalTitle').innerText = `Order #${r[0]}`;
                document.getElementById('modalBody').innerHTML = `<div style="font-size:1rem; color:#666; margin-bottom:10px;">進度：<b>${r[9]}</b><br>交期：<b>${r[2].split('T')[0]}</b></div><div style="margin-top:15px; border-top:1px dashed #eee; padding-top:15px; line-height:2;"><b>①</b> ${r[3]} / ${r[4]} / ${r[5]}${r[6]?'<br><b>②</b> '+r[6]+' / '+r[7]+' / '+r[8]:''}</div>`;
                document.getElementById('orderModal').style.display = 'block';
            }
        });
        calendar.render();
    }

    window.onload = function() {
        const now = new Date();
        document.getElementById('orderDate').value = (new Date(now - now.getTimezoneOffset()*60000)).toISOString().split('T')[0];
        calculateExpectedDate(document.getElementById('orderDate').value);

        fetch(`${scriptUrl}?action=getStyles`).then(res => res.json()).then(data => {
            const d = data.slice(1);
            const styles = [...new Set(d.map(i => i[0]))].filter(String);
            const colors = [...new Set(d.map(i => i[1]))].filter(String);
            
            // 填充篩選器
            const fs = document.getElementById('filterStyle');
            styles.forEach(s => { let o = document.createElement('option'); o.value=s; o.text=s; fs.add(o); });
            const fc = document.getElementById('filterColor');
            colors.forEach(c => { let o = document.createElement('option'); o.value=c; o.text=c; fc.add(o); });

            // 填充表單
            ['style1','style2'].forEach(id => setupSelect(id, styles, "Style..."));
            ['color1','color2'].forEach(id => setupSelect(id, colors, "Color..."));
            ['size1','size2'].forEach(id => setupSelect(id, ["XS", "S", "M", "L", "XL"], "Size..."));
            
            loadOrders();
        });
    };

    function setupSelect(id, list, p) {
        const s = document.getElementById(id);
        list.forEach(i => { let o = document.createElement('option'); o.value=i; o.text=i; s.add(o); });
        new Choices(s, { searchEnabled: true, itemSelectText: '', shouldSort: false });
    }

    function calculateExpectedDate(v) {
        if(!v) return ""; const d = new Date(v); d.setDate(d.getDate()+42);
        const res = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
        document.getElementById('expectedHint').innerText = `⮕ ${res}`; return res;
    }
    function closeModal() { document.getElementById('orderModal').style.display='none'; }
    function updateStatus(id, s) { if(!s) return; fetch(scriptUrl, { method: "POST", mode: "no-cors", body: JSON.stringify({action:'updateStatus', id:id, status:s}) }).then(() => loadOrders()); }
    function updateNote(id) { const n = document.getElementById(`note-${id}`).value; fetch(scriptUrl, { method: "POST", mode: "no-cors", body: JSON.stringify({action:'updateNote', id:id, note:n}) }).then(() => alert('備註已儲存')); }
    function submitOrder() {
        const id = document.getElementById('orderId').value; if(!id) return alert("請輸入 ID");
        const btn = document.getElementById('submitBtn'); btn.innerText = "處理中..."; btn.disabled = true;
        const d = document.getElementById('orderDate').value;
        const data = { id:id, deadline:d.replace(/-/g,'/'), expectedDate:calculateExpectedDate(d), s1:document.getElementById('style1').value, c1:document.getElementById('color1').value, z1:document.getElementById('size1').value, s2:document.getElementById('style2').value, c2:document.getElementById('color2').value, z2:document.getElementById('size2').value };
        fetch(scriptUrl, { method: "POST", mode: "no-cors", body: JSON.stringify({action:'addOrder', data:data}) }).then(() => { btn.innerText = "完成"; setTimeout(() => location.reload(), 1000); });
    }
</script>
</body>
</html>
