<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TIMU | 生產管理系統</title>
    
    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/d/1ImMExx8ZF1Qji8LgxoiM1KcXrH1touse"> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    
    <style>
        :root { 
            --brand-taupe: rgb(149, 134, 111); 
            --brand-dark: #373a3c;
            --off-white: #eff0f1; --text-light: #999;
            --error-red: #d93025;
            --st-new: #373a3c; --st-material: #8e8e8e; --st-sewing: #003b5c; --st-sent: #95866f; --st-done: #d0d0ce;
            --font-main: clamp(0.85rem, 0.4vw + 0.7rem, 1.1rem);
            --font-title: clamp(1rem, 0.8vw + 0.8rem, 1.4rem);
            --font-label: clamp(0.55rem, 0.3vw + 0.5rem, 0.75rem);
        }
        body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; background: var(--off-white); color: var(--brand-dark); padding: 10px; margin: 0; min-height: 100vh; -webkit-font-smoothing: antialiased; }
        .brand-header { text-align: center; padding: clamp(20px, 5vh, 40px) 0; }
        .brand-logo { width: 220px; height: auto; max-width: 75%; }
        .nav { text-align: center; margin-bottom: 20px; position: sticky; top: 0; z-index: 1000; background: var(--off-white); padding: 10px 0; overflow-x: auto; }
        .nav button { background: transparent; border: none; color: var(--text-light); padding: 10px 20px; cursor: pointer; letter-spacing: 2px; font-size: var(--font-label); font-weight: 500; transition: 0.3s; }
        .nav button.active-btn { color: var(--brand-dark); border-bottom: 2px solid var(--brand-dark); }
        .page-container { display: none; background: white; margin: 0 auto 40px auto; padding: clamp(20px, 4vw, 40px); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); width: calc(100% - 30px); box-sizing: border-box; }
        .active { display: block; }
        #formTab { max-width: 650px; }
        #adminTab, #calendarTab, #statsTab { max-width: 1000px; }
        .title-group { text-align: center; margin-bottom: 30px; }
        h2 { font-weight: 300; letter-spacing: 8px; font-size: var(--font-title); color: var(--brand-dark); margin: 0; }
        .sub-title { font-size: var(--font-label); color: var(--brand-taupe); margin-top: 10px; letter-spacing: 3px; font-weight: bold; }
        .item-header { font-size: var(--font-label); font-weight: bold; letter-spacing: 2px; color: var(--brand-taupe); margin: 40px 0 20px 0; padding-bottom: 8px; border-bottom: 1.5px solid #f0f0f0; display: block; }
        .form-group { margin-bottom: 25px; }
        label { display: block; font-size: var(--font-label); color: #bbb; letter-spacing: 1px; margin-bottom: 8px; font-weight: 600; }
        input { padding: 10px 0; border: none !important; border-bottom: 1px solid #eee !important; font-size: var(--font-main); width: 100%; background: transparent !important; color: #555; outline: none; border-radius: 0; }
        .choices__inner { border: none !important; border-bottom: 1px solid #eee !important; background: transparent !important; padding: 6px 0 !important; min-height: 40px !important; font-size: var(--font-main); }
        
        /* 錯誤顯示樣式 */
        .choices__item--selectable[data-value="ERROR"] { color: var(--error-red) !important; font-weight: bold; }
        .error-msg { color: var(--error-red); font-size: 0.65rem; margin-top: 5px; font-weight: bold; display: none; }

        .btn-submit { background: var(--brand-dark); color: white; border: none; padding: 20px; width: 100%; margin-top: 30px; cursor: pointer; letter-spacing: 4px; font-size: 0.8rem; border-radius: 8px; font-weight: bold; transition: 0.4s; }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; }
        .btn-submit.success { background: var(--brand-taupe); }

        /* 列表與日曆樣式同前 */
        .order-card { padding: 25px 0; border-bottom: 1px solid #f7f7f7; display: flex; flex-direction: column; gap: 15px; }
        @media (min-width: 600px) { .order-card { flex-direction: row; justify-content: space-between; align-items: center; } }
        .countdown-label { font-size: 0.65rem; font-weight: bold; padding: 3px 10px; border-radius: 20px; display: inline-block; margin-bottom: 8px; letter-spacing: 1px; }
        .bg-urgent { background: #fee2e2; color: #dc2626; }
        .bg-normal { background: #f3f4f6; color: var(--brand-taupe); }
        .status-tag { padding: 5px 12px; border-radius: 4px; font-size: 0.65rem; color: white; font-weight: bold; display: inline-block; }
        .status-新訂單 { background: var(--st-new); }
        .status-備料中 { background: var(--st-material); }
        .status-車縫中 { background: var(--st-sewing); }
        .status-已寄回 { background: var(--st-sent); }
        .status-出貨完畢 { background: var(--st-done); color: var(--brand-dark); }
        .stats-row { padding: 15px 0; font-size: var(--font-main); border-bottom: 1px solid #fafafa; display: flex; justify-content: space-between; }
        .footer-copyright { text-align: center; padding: 40px 0; font-size: 0.6rem; color: rgba(149, 134, 111, 0.4); letter-spacing: 1px; }
    </style>
</head>
<body>

<div class="brand-header">
    <img src="https://lh3.googleusercontent.com/d/12yR1r7b4SlVYa9T3quajqKZmqeO7MLPb" alt="TIMU" class="brand-logo">
</div>

<div class="nav">
    <button id="btnForm" class="active-btn" onclick="showTab('form')">NEW ORDER</button>
    <button id="btnAdmin" onclick="showTab('admin')">STATUS</button>
    <button id="btnCalendar" onclick="showTab('calendar')">CALENDAR</button>
    <button id="btnStats" onclick="showTab('stats')">STATISTICS</button>
</div>

<div class="main-content">
    <div id="formTab" class="page-container active">
        <div class="title-group"><h2>NEW ORDER</h2><div class="sub-title">建立新訂製單</div></div>
        <div class="form-group"><label>Order ID</label><input type="text" id="orderId" placeholder="SL-0000"></div>
        <div class="form-group"><label>Order Date</label><input type="date" id="orderDate" onchange="updateExpectedDate(this.value)"></div>
        
        <span class="item-header">ITEM 01 內容詳情</span>
        <div class="form-group"><label>Style (代碼)</label><select id="style1"></select></div>
        <div class="form-group">
            <label>Color (自動偵測)</label>
            <select id="color1"></select>
            <div id="err1" class="error-msg">⚠️ 無對應布料 (請從款式名稱確認後手動更正)</div>
        </div>
        <div class="form-group"><label>Size</label><select id="size1"></select></div>
        
        <span class="item-header">ITEM 02 內容詳情</span>
        <div class="form-group"><label>Style (代碼)</label><select id="style2"></select></div>
        <div class="form-group">
            <label>Color (自動偵測)</label>
            <select id="color2"></select>
            <div id="err2" class="error-msg">⚠️ 無對應布料 (請從款式名稱確認後手動更正)</div>
        </div>
        <div class="form-group"><label>Size</label><select id="size2"></select></div>
        
        <button id="submitBtn" class="btn-submit" onclick="submitOrder()">CREATE ORDER</button>
    </div>

    <div id="adminTab" class="page-container">
        <div class="title-group"><h2>STATUS</h2><div class="sub-title">生產進度管理</div></div>
        <div id="orderList">載入中...</div>
    </div>
    <div id="calendarTab" class="page-container"><div id="calendar"></div></div>
    <div id="statsTab" class="page-container">
        <div id="totalPieces" style="text-align:center; font-size: 2.5rem; color: var(--brand-taupe); margin: 20px 0;">0</div>
        <div id="statsTableBody"></div>
    </div>
</div>

<script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbyi0WHv5eEFxL5XVKiPsr_iU6Ipoa0OxJJQvTjmjzicQTrNRK16fTUqD2_qeskcoXVcZg/exec";
    let allOrders = null;
    let colorKeywords = []; 
    let choicesInstances = {};

    // --- 強化版自動偵測：解決黑色/泡泡/XTRA LIFE 問題 ---
    function autoDetectColor(styleId, colorId, errId) {
        const styleName = document.getElementById(styleId).value.toUpperCase().replace(/\s+/g, '');
        const colorChoice = choicesInstances[colorId];
        const errDisplay = document.getElementById(errId);
        
        if (!styleName) return;

        // 邏輯 1：提取 Style 裡的英文關鍵字
        // 邏輯 2：檢查顏色庫中是否有同時包含「該關鍵字」與「材質特徵」的選項
        let matched = colorKeywords.find(fullName => {
            const nameUp = fullName.toUpperCase();
            const englishKey = fullName.split(/[^\a-zA-Z\s]/)[0].trim().toUpperCase().replace(/\s+/g, '');
            
            // 判斷黑色泡泡特殊邏輯 (假設泡泡代碼含有 SEER 或 SEERSUCKER)
            if (styleName.includes("SEER") && nameUp.includes("泡泡") && styleName.includes(englishKey)) return true;
            // 判斷 XTRA LIFE
            if (styleName.includes("XTRA") && nameUp.includes("XTRA") && styleName.includes(englishKey)) return true;
            // 一般匹配
            return englishKey.length > 2 && styleName.includes(englishKey);
        });

        if (matched) {
            colorChoice.setChoiceByValue(matched);
            errDisplay.style.display = 'none';
        } else {
            // 沒抓到對應布料：顯示錯誤訊息並重置
            colorChoice.setChoiceByValue('ERROR'); 
            errDisplay.style.display = 'block';
        }
        checkFormValidity();
    }

    // 檢查表單是否可以送出
    function checkFormValidity() {
        const c1 = document.getElementById('color1').value;
        const c2 = document.getElementById('color2').value;
        const btn = document.getElementById('submitBtn');
        // 如果任何一個顏色是 ERROR，就禁用按鈕
        btn.disabled = (c1 === 'ERROR' || (document.getElementById('style2').value && c2 === 'ERROR'));
    }

    // 初始化選單時加入錯誤選項
    function initChoice(id, list, placeholder, changeFn) {
        const el = document.getElementById(id);
        el.innerHTML = `<option value="">${placeholder}</option>`;
        if (id.startsWith('color')) el.add(new Option("⚠️ 無對應布料", "ERROR"));
        list.forEach(i => el.add(new Option(i, i)));
        const c = new Choices(el, { searchEnabled: true, itemSelectText: '', shouldSort: false });
        if(changeFn) el.addEventListener('change', () => { changeFn(); checkFormValidity(); });
        choicesInstances[id] = c;
        return c;
    }

    // 以下功能與之前版本完全一致 (提交、渲染、統計、日曆等)
    async function submitOrder() {
        const btn = document.getElementById('submitBtn');
        const orderId = document.getElementById('orderId').value;
        if(!orderId || btn.disabled) return;
        btn.innerText = "SENDING..."; btn.disabled = true;
        let exp = new Date(document.getElementById('orderDate').value); exp.setDate(exp.getDate() + 42);
        const payload = {
            action: 'addOrder',
            data: {
                id: orderId, deadline: document.getElementById('orderDate').value, expectedDate: exp.toISOString().split('T')[0],
                s1: document.getElementById('style1').value, c1: document.getElementById('color1').value, z1: document.getElementById('size1').value,
                s2: document.getElementById('style2').value, c2: document.getElementById('color2').value, z2: document.getElementById('size2').value,
                hasStock: false
            }
        };
        try {
            await fetch(scriptUrl, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
            btn.classList.add('success'); btn.innerText = "✓ ORDER CREATED";
            setTimeout(() => { location.reload(); }, 1500);
        } catch (e) { btn.innerText = "ERROR"; btn.disabled = false; }
    }

    window.onload = async function() {
        document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
        try {
            const res = await fetch(`${scriptUrl}?action=getStyles`);
            const data = await res.json();
            const raw = data.slice(1);
            const styles = [...new Set(raw.map(i => i[0].toString()))].filter(String).sort();
            colorKeywords = [...new Set(raw.map(i => i[1].toString()))].filter(String);
            
            initChoice('style1', styles, "STYLE...", () => autoDetectColor('style1', 'color1', 'err1'));
            initChoice('style2', styles, "STYLE...", () => autoDetectColor('style2', 'color2', 'err2'));
            initChoice('color1', colorKeywords.sort(), "COLOR...");
            initChoice('color2', colorKeywords.sort(), "COLOR...");
            ['size1', 'size2'].forEach(id => initChoice(id, ["XS", "S", "M", "L", "XL"], "SIZE..."));
            loadOrders();
        } catch (e) { console.error(e); }
    };

    async function showTab(t) {
        document.querySelectorAll('.page-container').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav button').forEach(e => e.classList.remove('active-btn'));
        document.getElementById(t + 'Tab').classList.add('active');
        document.getElementById('btn' + t.charAt(0).toUpperCase() + t.slice(1)).classList.add('active-btn');
        if (t === 'admin' && allOrders) renderOrders(allOrders.slice().reverse());
        if (t === 'calendar' && allOrders) setTimeout(renderCalendar, 100);
    }
    // (其餘 renderOrders, renderCalendar, renderStatistics 等函數與前版相同，已在此省略以符合長度限制)
</script>
</body>
</html>
